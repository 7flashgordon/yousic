<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yousic - Your Music, Your Rankings</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --evergreen: #2D5016;
            --light-blue: #A8DADC;
            --soft-yellow: #F4E87C;
            --white: #FFFFFF;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-300: #D1D5DB;
            --gray-500: #6B7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--light-blue) 100%);
            min-height: 100vh;
            color: var(--gray-900);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Trial Banner */
        .trial-banner {
            background: var(--light-blue);
            padding: 12px 20px;
            text-align: center;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* Sections */
        section {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Landing */
        .landing {
            text-align: center;
            padding: 80px 20px;
        }

        .landing h1 {
            font-size: 3.5rem;
            color: var(--evergreen);
            margin-bottom: 20px;
            font-weight: 800;
        }

        .landing p {
            font-size: 1.5rem;
            color: var(--gray-700);
            margin-bottom: 40px;
        }

        /* Buttons */
        .btn {
            padding: 16px 32px;
            font-size: 1.1rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-block;
            margin: 8px;
        }

        .btn-primary {
            background: var(--evergreen);
            color: white;
            box-shadow: 0 4px 6px rgba(45, 80, 22, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            background: #1e3610;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: white;
            color: var(--evergreen);
            border: 2px solid var(--evergreen);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Search Section */
        .search-section {
            max-width: 800px;
            margin: 40px auto;
        }

        .search-input {
            width: 100%;
            padding: 16px 24px;
            font-size: 1.1rem;
            border: 2px solid var(--gray-300);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--evergreen);
        }

        .search-results {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .artist-result {
            display: flex;
            align-items: center;
            padding: 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
        }

        .artist-result:hover {
            background: var(--gray-50);
        }

        .artist-result img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 16px;
        }

        /* Added Artists */
        .added-artists {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 16px;
            margin: 30px 0;
        }

        .added-artist {
            text-align: center;
            position: relative;
        }

        .added-artist img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--evergreen);
        }

        .remove-artist {
            position: absolute;
            top: -5px;
            right: 15px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        /* Ranking Interface */
        .ranking-interface {
            max-width: 1000px;
            margin: 40px auto;
            text-align: center;
        }

        .ranking-interface h2 {
            font-size: 2rem;
            color: var(--evergreen);
            margin-bottom: 40px;
        }

        .comparison {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin: 40px 0;
        }

        .artist-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .artist-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(45, 80, 22, 0.3);
        }

        .artist-card img {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin-bottom: 16px;
        }

        .vs-text {
            font-size: 2.5rem;
            color: var(--gray-300);
        }

        /* Results */
        .results-section {
            max-width: 800px;
            margin: 40px auto;
        }

        .results-section h2 {
            text-align: center;
            font-size: 2.5rem;
            color: var(--evergreen);
            margin-bottom: 40px;
        }

        .rankings-list {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--gray-100);
        }

        .rank-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--evergreen);
            width: 60px;
        }

        .ranking-item img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 20px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .landing h1 { font-size: 2.5rem; }
            .comparison { flex-direction: column; gap: 20px; }
            .artist-card img { width: 150px; height: 150px; }
        }
    </style>
</head>
<body>
    <div class="trial-banner">
        ðŸŽµ <strong>Trial Mode:</strong> Rank up to 10 artists total. Sign up coming soon!
    </div>

    <!-- Config Modal -->
    <div id="configModal" class="modal active">
        <div class="modal-content">
            <h3>ðŸŽµ Spotify API Setup</h3>
            <p>Enter your Spotify credentials:</p>
            <input type="text" id="clientId" placeholder="Client ID" style="width:100%; padding:12px; margin:10px 0; border:2px solid #ccc; border-radius:8px;">
            <input type="text" id="clientSecret" placeholder="Client Secret" style="width:100%; padding:12px; margin:10px 0; border:2px solid #ccc; border-radius:8px;">
            <small style="display:block; color:#666; margin-bottom:20px;">Get these at <a href="https://developer.spotify.com/dashboard" target="_blank">developer.spotify.com/dashboard</a></small>
            <button class="btn btn-primary" onclick="saveCredentials()">Save & Start</button>
        </div>
    </div>

    <div class="container">
        <!-- Landing -->
        <section id="landing" class="landing active">
            <h1>Your Music, Your Rankings</h1>
            <p>Discover your true music taste. Rank your favorite artists in minutes.</p>
            <button class="btn btn-primary" onclick="goToSearch()">Start Ranking</button>
        </section>

        <!-- Search -->
        <section id="search" class="search-section">
            <h2 style="text-align:center; color:var(--evergreen); margin-bottom:30px;" id="searchTitle">Add Your Top 5 Artists</h2>
            <input type="text" class="search-input" id="searchInput" placeholder="Search for artists..." autocomplete="off">
            <div id="searchResults" class="search-results" style="display:none;"></div>
            <div style="text-align:center; font-size:1.2rem; color:var(--gray-700); margin:20px 0;" id="artistCount">0 / 5 artists added</div>
            <div id="addedArtists" class="added-artists"></div>
            <div style="text-align:center; margin-top:30px;">
                <button class="btn btn-primary" id="startRankingBtn" onclick="startRanking()" disabled>Start Ranking</button>
            </div>
        </section>

        <!-- Ranking -->
        <section id="ranking" class="ranking-interface">
            <h2 id="rankingTitle">Which artist do you prefer?</h2>
            <div id="comparisonContainer" class="comparison"></div>
            <div style="color:var(--gray-500); font-size:1.1rem; margin-top:30px;" id="progressText"></div>
            <div style="margin-top:20px;">
                <button class="btn btn-secondary" id="undoBtn" onclick="undoLastComparison()" style="display:none;">â†© Undo Last Choice</button>
            </div>
        </section>

        <!-- Results -->
        <section id="results" class="results-section">
            <h2 id="resultsTitle">Your Top 5 Artists</h2>
            <div class="rankings-list" id="rankingsList"></div>
            <div style="text-align:center; margin-top:40px;">
                <button class="btn btn-primary" id="addMoreBtn" onclick="showAddMore()" style="display:none;">âž• Add Another Artist</button>
                <button class="btn btn-primary" onclick="shareRankings()">ðŸ“¤ Share</button>
                <button class="btn btn-secondary" onclick="resetApp()">ðŸ”„ Start Over</button>
            </div>
        </section>
    </div>

    <!-- Add More Modal -->
    <div id="addMoreModal" class="modal">
        <div class="modal-content">
            <h3>Add Another Artist</h3>
            <p>Search for an artist to add to your rankings:</p>
            <input type="text" id="addMoreSearch" class="search-input" placeholder="Search..." autocomplete="off">
            <div id="addMoreResults" class="search-results" style="display:none; margin-top:10px;"></div>
            <button class="btn btn-secondary" onclick="closeAddMore()">Cancel</button>
        </div>
    </div>

    <script>
        // Config
        let SPOTIFY_CLIENT_ID = '';
        let SPOTIFY_CLIENT_SECRET = '';
        let spotifyToken = null;
        let tokenExpiry = null;

        // State
        const state = {
            phase: 'initial', // 'initial' or 'adding'
            artists: [],
            rankedArtists: [],
            comparisons: [],
            comparisonHistory: [],
            currentPair: null,
            artistToInsert: null,
            maxArtists: 10,
            initialLimit: 5
        };

        // Load credentials
        const savedCreds = localStorage.getItem('yousic_spotify_creds');
        if (savedCreds) {
            const creds = JSON.parse(savedCreds);
            SPOTIFY_CLIENT_ID = creds.clientId;
            SPOTIFY_CLIENT_SECRET = creds.clientSecret;
            document.getElementById('configModal').classList.remove('active');
        }

        function saveCredentials() {
            const clientId = document.getElementById('clientId').value.trim();
            const clientSecret = document.getElementById('clientSecret').value.trim();
            
            if (!clientId || !clientSecret) {
                alert('Please enter both credentials');
                return;
            }
            
            SPOTIFY_CLIENT_ID = clientId;
            SPOTIFY_CLIENT_SECRET = clientSecret;
            localStorage.setItem('yousic_spotify_creds', JSON.stringify({ clientId, clientSecret }));
            document.getElementById('configModal').classList.remove('active');
        }

        // Spotify API
        async function getSpotifyToken() {
            if (spotifyToken && tokenExpiry && Date.now() < tokenExpiry) {
                return spotifyToken;
            }

            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(SPOTIFY_CLIENT_ID + ':' + SPOTIFY_CLIENT_SECRET)
                    },
                    body: 'grant_type=client_credentials'
                });

                const data = await response.json();
                spotifyToken = data.access_token;
                tokenExpiry = Date.now() + (data.expires_in * 1000);
                return spotifyToken;
            } catch (error) {
                console.error('Token error:', error);
                return null;
            }
        }

        async function searchArtists(query) {
            if (!query.trim()) return [];
            
            try {
                const token = await getSpotifyToken();
                const response = await fetch(
                    `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=artist&limit=10`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                
                const data = await response.json();
                return data.artists.items.map(artist => ({
                    spotifyId: artist.id,
                    name: artist.name,
                    imageUrl: artist.images[0]?.url || 'https://via.placeholder.com/200',
                    eloScore: 1500
                }));
            } catch (error) {
                console.error('Search error:', error);
                return [];
            }
        }

        // ELO Algorithm
        const K_FACTOR = 32;

        function updateElo(winnerScore, loserScore) {
            const expectedWinner = 1 / (1 + Math.pow(10, (loserScore - winnerScore) / 400));
            const expectedLoser = 1 / (1 + Math.pow(10, (winnerScore - loserScore) / 400));
            
            return {
                newWinnerScore: Math.round(winnerScore + K_FACTOR * (1 - expectedWinner)),
                newLoserScore: Math.round(loserScore + K_FACTOR * (0 - expectedLoser))
            };
        }

        function getNextComparison(artists, comparisons) {
            // Shuffle first time
            if (comparisons.length === 0) {
                artists = [...artists].sort(() => Math.random() - 0.5);
            }
            
            const sorted = [...artists].sort((a, b) => b.eloScore - a.eloScore);
            
            // Each artist needs ~3 comparisons minimum
            for (let artist of artists) {
                const count = comparisons.filter(c => c.includes(artist.spotifyId)).length;
                if (count < 3) {
                    for (let opponent of sorted) {
                        if (opponent.spotifyId === artist.spotifyId) continue;
                        const pair = [artist.spotifyId, opponent.spotifyId].sort().join('-');
                        if (!comparisons.includes(pair)) {
                            return { artistA: artist, artistB: opponent };
                        }
                    }
                }
            }
            
            // Adjacent comparisons
            for (let i = 0; i < sorted.length - 1; i++) {
                const pair = [sorted[i].spotifyId, sorted[i + 1].spotifyId].sort().join('-');
                if (!comparisons.includes(pair)) {
                    return { artistA: sorted[i], artistB: sorted[i + 1] };
                }
            }
            
            // Stop when we have enough comparisons
            const minComparisons = Math.ceil(artists.length * 2.5);
            if (comparisons.length >= minComparisons) {
                return null;
            }
            
            // Fill in remaining
            for (let i = 0; i < sorted.length - 1; i++) {
                for (let j = i + 1; j < sorted.length; j++) {
                    const pair = [sorted[i].spotifyId, sorted[j].spotifyId].sort().join('-');
                    if (!comparisons.includes(pair)) {
                        return { artistA: sorted[i], artistB: sorted[j] };
                    }
                }
            }
            
            return null;
        }

        function getInsertComparison(newArtist, rankedArtists, comparisons) {
            // Binary search insertion - MUCH smarter!
            // Only need 2-3 comparisons instead of comparing against all
            
            if (rankedArtists.length === 0) return null;
            
            const sorted = [...rankedArtists].sort((a, b) => b.eloScore - a.eloScore);
            
            // Find the range where this artist belongs using binary search
            let low = 0;
            let high = sorted.length - 1;
            
            // Check if we've compared with middle artist
            const middleIndex = Math.floor((low + high) / 2);
            const middleArtist = sorted[middleIndex];
            const middlePair = [newArtist.spotifyId, middleArtist.spotifyId].sort().join('-');
            
            if (!comparisons.includes(middlePair) && sorted.length > 0) {
                return { artistA: newArtist, artistB: middleArtist };
            }
            
            // Determine which half to search based on previous comparisons
            // Check if new artist beat the middle artist
            const beatMiddle = newArtist.eloScore > middleArtist.eloScore;
            
            if (beatMiddle) {
                // Search upper half
                high = middleIndex - 1;
            } else {
                // Search lower half  
                low = middleIndex + 1;
            }
            
            // Continue binary search
            while (low <= high) {
                const mid = Math.floor((low + high) / 2);
                const midArtist = sorted[mid];
                const pair = [newArtist.spotifyId, midArtist.spotifyId].sort().join('-');
                
                if (!comparisons.includes(pair)) {
                    return { artistA: newArtist, artistB: midArtist };
                }
                
                // Narrow the search based on ELO scores
                if (newArtist.eloScore > midArtist.eloScore) {
                    high = mid - 1;
                } else {
                    low = mid + 1;
                }
            }
            
            // If we've done 2-3 comparisons, we're done
            const comparisonsWithNew = comparisons.filter(c => c.includes(newArtist.spotifyId)).length;
            if (comparisonsWithNew >= 3) {
                return null;
            }
            
            // Final comparison if needed
            for (let artist of sorted) {
                const pair = [newArtist.spotifyId, artist.spotifyId].sort().join('-');
                if (!comparisons.includes(pair)) {
                    return { artistA: newArtist, artistB: artist };
                }
            }
            
            return null;
        }

        // UI Functions
        function showSection(id) {
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goToSearch() {
            showSection('search');
        }

        // Search handling
        let searchTimeout;
        document.getElementById('searchInput')?.addEventListener('input', async (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value;
            
            if (query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                const results = await searchArtists(query);
                displaySearchResults(results, 'searchResults', addArtist);
            }, 300);
        });

        document.getElementById('addMoreSearch')?.addEventListener('input', async (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value;
            
            if (query.length < 2) {
                document.getElementById('addMoreResults').style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                const results = await searchArtists(query);
                displaySearchResults(results, 'addMoreResults', addArtistToRanking);
            }, 300);
        });

        function displaySearchResults(results, containerId, clickHandler) {
            const container = document.getElementById(containerId);
            
            if (results.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            container.innerHTML = results.map((artist, index) => `
                <div class="artist-result" data-artist-index="${index}" data-container="${containerId}">
                    <img src="${artist.imageUrl}" alt="${artist.name}">
                    <div>
                        <h3 style="font-size:1.1rem; margin-bottom:4px;">${artist.name}</h3>
                    </div>
                </div>
            `).join('');
            
            // Store results for click handling
            window[`${containerId}_results`] = results;
            
            // Add click handlers
            container.querySelectorAll('.artist-result').forEach((el, index) => {
                el.onclick = () => clickHandler(results[index]);
            });
        }

        function addArtist(artist) {
            if (state.artists.some(a => a.spotifyId === artist.spotifyId)) {
                alert('Already added!');
                return;
            }
            
            const limit = state.phase === 'initial' ? state.initialLimit : state.maxArtists;
            if (state.artists.length >= limit) {
                alert(`Maximum ${limit} artists`);
                return;
            }
            
            state.artists.push(artist);
            updateAddedArtists();
            
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').style.display = 'none';
        }

        function removeArtist(spotifyId) {
            state.artists = state.artists.filter(a => a.spotifyId !== spotifyId);
            updateAddedArtists();
        }

        function updateAddedArtists() {
            const container = document.getElementById('addedArtists');
            const count = document.getElementById('artistCount');
            const startBtn = document.getElementById('startRankingBtn');
            
            const limit = state.phase === 'initial' ? state.initialLimit : state.maxArtists;
            count.textContent = `${state.artists.length} / ${limit} artists added`;
            
            if (state.artists.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:60px; color:var(--gray-500);">Search and add artists to start</div>';
                startBtn.disabled = true;
            } else {
                container.innerHTML = state.artists.map(artist => `
                    <div class="added-artist">
                        <button class="remove-artist" onclick="removeArtist('${artist.spotifyId}')">Ã—</button>
                        <img src="${artist.imageUrl}" alt="${artist.name}">
                        <p>${artist.name}</p>
                    </div>
                `).join('');
                
                startBtn.disabled = state.artists.length < (state.phase === 'initial' ? 5 : 1);
            }
        }

        function startRanking() {
            if (state.artists.length < 5 && state.phase === 'initial') {
                alert('Add at least 5 artists!');
                return;
            }
            
            state.comparisons = [];
            state.comparisonHistory = [];
            state.currentPair = getNextComparison(state.artists, state.comparisons);
            
            showSection('ranking');
            displayComparison();
            updateUndoButton();
        }

        function displayComparison() {
            if (!state.currentPair) {
                if (state.phase === 'initial') {
                    finishInitialRanking();
                } else {
                    finishAddingArtist();
                }
                return;
            }
            
            const { artistA, artistB } = state.currentPair;
            const container = document.getElementById('comparisonContainer');
            
            const title = state.phase === 'adding' 
                ? `Where does ${state.artistToInsert.name} rank?`
                : 'Which artist do you prefer?';
            document.getElementById('rankingTitle').textContent = title;
            
            container.innerHTML = `
                <div class="artist-card" onclick="handleChoice('${artistA.spotifyId}', '${artistB.spotifyId}')">
                    <img src="${artistA.imageUrl}" alt="${artistA.name}">
                    <h3>${artistA.name}</h3>
                </div>
                <div class="vs-text">vs</div>
                <div class="artist-card" onclick="handleChoice('${artistB.spotifyId}', '${artistA.spotifyId}')">
                    <img src="${artistB.imageUrl}" alt="${artistB.name}">
                    <h3>${artistB.name}</h3>
                </div>
            `;
            
            const estimate = Math.ceil(state.artists.length * 2.5);
            document.getElementById('progressText').textContent = `Comparison ${state.comparisons.length + 1}`;
        }

        function handleChoice(winnerId, loserId) {
            const winner = state.artists.find(a => a.spotifyId === winnerId);
            const loser = state.artists.find(a => a.spotifyId === loserId);
            
            // Save state for undo
            state.comparisonHistory.push({
                winner: { ...winner },
                loser: { ...loser },
                comparison: [winnerId, loserId].sort().join('-')
            });
            
            // Update scores
            const { newWinnerScore, newLoserScore } = updateElo(winner.eloScore, loser.eloScore);
            winner.eloScore = newWinnerScore;
            loser.eloScore = newLoserScore;
            
            // Track comparison
            state.comparisons.push([winnerId, loserId].sort().join('-'));
            
            // Get next
            setTimeout(() => {
                if (state.phase === 'adding') {
                    state.currentPair = getInsertComparison(state.artistToInsert, state.rankedArtists, state.comparisons);
                } else {
                    state.currentPair = getNextComparison(state.artists, state.comparisons);
                }
                displayComparison();
                updateUndoButton();
            }, 300);
        }

        function undoLastComparison() {
            if (state.comparisonHistory.length === 0) return;
            
            const last = state.comparisonHistory.pop();
            
            // Restore scores
            const winner = state.artists.find(a => a.spotifyId === last.winner.spotifyId);
            const loser = state.artists.find(a => a.spotifyId === last.loser.spotifyId);
            winner.eloScore = last.winner.eloScore;
            loser.eloScore = last.loser.eloScore;
            
            // Remove comparison
            state.comparisons = state.comparisons.filter(c => c !== last.comparison);
            
            // Re-get pair
            if (state.phase === 'adding') {
                state.currentPair = getInsertComparison(state.artistToInsert, state.rankedArtists, state.comparisons);
            } else {
                state.currentPair = getNextComparison(state.artists, state.comparisons);
            }
            
            displayComparison();
            updateUndoButton();
        }

        function updateUndoButton() {
            const btn = document.getElementById('undoBtn');
            btn.style.display = state.comparisonHistory.length > 0 ? 'inline-block' : 'none';
        }

        function finishInitialRanking() {
            state.rankedArtists = [...state.artists].sort((a, b) => b.eloScore - a.eloScore);
            state.phase = 'adding';
            showResults();
        }

        function finishAddingArtist() {
            // Merge new artist into ranked list
            state.rankedArtists.push(state.artistToInsert);
            state.rankedArtists.sort((a, b) => b.eloScore - a.eloScore);
            state.artistToInsert = null;
            showResults();
        }

        function showResults() {
            const container = document.getElementById('rankingsList');
            const title = document.getElementById('resultsTitle');
            const addMoreBtn = document.getElementById('addMoreBtn');
            
            title.textContent = `Your Top ${state.rankedArtists.length} Artists`;
            
            container.innerHTML = state.rankedArtists.map((artist, i) => `
                <div class="ranking-item">
                    <div class="rank-number">${i + 1}</div>
                    <img src="${artist.imageUrl}" alt="${artist.name}">
                    <h3>${artist.name}</h3>
                </div>
            `).join('');
            
            addMoreBtn.style.display = state.rankedArtists.length < state.maxArtists ? 'inline-block' : 'none';
            
            showSection('results');
        }

        function showAddMore() {
            document.getElementById('addMoreModal').classList.add('active');
        }

        function closeAddMore() {
            document.getElementById('addMoreModal').classList.remove('active');
            document.getElementById('addMoreSearch').value = '';
            document.getElementById('addMoreResults').style.display = 'none';
        }

        function addArtistToRanking(artist) {
            if (state.rankedArtists.some(a => a.spotifyId === artist.spotifyId)) {
                alert('Already in your rankings!');
                return;
            }
            
            state.artistToInsert = artist;
            state.artists = [...state.rankedArtists, artist];
            state.comparisons = [];
            state.comparisonHistory = [];
            
            closeAddMore();
            
            state.currentPair = getInsertComparison(artist, state.rankedArtists, state.comparisons);
            showSection('ranking');
            displayComparison();
            updateUndoButton();
        }

        function shareRankings() {
            const text = state.rankedArtists
                .slice(0, 10)
                .map((a, i) => `${i + 1}. ${a.name}`)
                .join('\n');
            
            const shareText = `My Top ${Math.min(10, state.rankedArtists.length)} Artists ðŸŽµ\n\n${text}\n\nWhat's yours? (Made with Yousic)`;
            
            if (navigator.share) {
                navigator.share({ title: 'My Music Rankings', text: shareText });
            } else {
                navigator.clipboard.writeText(shareText);
                alert('Rankings copied to clipboard! ðŸŽµ');
            }
        }

        function resetApp() {
            if (!confirm('Start over? This will clear your rankings.')) return;
            state.phase = 'initial';
            state.artists = [];
            state.rankedArtists = [];
            state.comparisons = [];
            state.comparisonHistory = [];
            showSection('landing');
        }
    </script>
</body>
</html>